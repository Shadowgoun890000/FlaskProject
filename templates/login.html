<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login - Sistema de Turnos</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    .login-container{
      min-height:100vh;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      padding:16px;
    }
    .login-card{
      background:var(--surface, #fff);
      padding:2rem;border-radius:var(--border-radius, 12px);
      box-shadow:var(--shadow, 0 8px 24px rgba(0,0,0,.12));
      width:100%;max-width:420px;
    }
    .captcha-container{
      background:var(--surface-2, #f8f9fa);
      padding:1rem;border-radius:var(--border-radius, 12px);
      text-align:center;margin-bottom:1rem; border:1px solid var(--muted, #e5e7eb);
    }
    .captcha-text{
      font-family:'Courier New', monospace;font-size:1.5rem;font-weight:800;
      letter-spacing:3px;color:var(--primary-color, #2563eb);margin-bottom:.5rem;
      user-select:none; cursor:pointer;
    }
    .public-access{ text-align:center;margin-top:1rem;padding-top:1rem;border-top:1px solid #eee; }
  </style>
</head>
<body>
    <button id="themeToggle" class="btn theme-toggle" type="button" title="Cambiar tema"
        style="position: fixed; top: 16px; right: 16px; z-index: 1000;">üåì</button>
  <div class="login-container">
    <div class="login-card">
      <div class="header" style="display:block;text-align:center;margin-bottom:12px;">
        <h1 style="margin:0 0 6px 0;">üîê Acceso</h1>
        <p class="help-text" style="margin:0;">Inicia sesi√≥n como <strong>administrador</strong> o <strong>usuario</strong></p>
      </div>

      <!-- Mensajes flash -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert {{ 'alert-error' if category == 'error' else 'alert-info' }}">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form id="loginForm" method="POST" action="{{ url_for('login') }}" novalidate>
        <div class="form-group">
          <label for="username">Usuario o correo</label>
          <input
            type="text" id="username" name="username" class="form-control" required
            placeholder="Ingresa tu usuario o correo"
            autocomplete="username"
          >
        </div>

        <div class="form-group">
          <label for="password">Contrase√±a</label>
          <div style="position:relative;">
            <input
              type="password" id="password" name="password" class="form-control" required
              placeholder="Ingresa tu contrase√±a" autocomplete="current-password"
            >
            <button type="button" id="togglePwd"
              aria-label="Mostrar u ocultar contrase√±a"
              class="btn btn-secondary"
              style="position:absolute; right:6px; top:6px; padding:8px 10px;">
              üëÅ
            </button>
          </div>
        </div>

        <div class="alert alert-info" role="status" aria-live="polite" style="margin-bottom:12px;">
          Da clic en el c√≥digo para recargar otro CAPTCHA si no se entiende.
        </div>

        <div class="captcha-container">
          <div class="captcha-text" id="captchaText" title="Clic para recargar">{{ captcha_text }}</div>
          <input type="hidden" name="captcha_answer" value="{{ captcha_answer }}">
          <div class="form-group" style="margin-top:10px;">
            <label for="captcha_input">Ingresa el texto de arriba</label>
            <input type="text" id="captcha_input" name="captcha_input" class="form-control" required
                   placeholder="Escribe el c√≥digo CAPTCHA" inputmode="latin" autocomplete="off">
          </div>
        </div>

        <button type="submit" class="btn btn-primary btn-block">Iniciar Sesi√≥n</button>
      </form>

      <div class="public-access">
        <p>¬øEres usuario p√∫blico?</p>
        <a href="{{ url_for('publico') }}" class="btn btn-secondary btn-block">üåê Ir al Formulario P√∫blico</a>

        <!-- (Opcional) Si ya tienes /user/register, muestra el link de alta de usuarios -->
        {% if url_for('register_user', _anchor=None) %}
          <div style="margin-top:8px;">
            <a href="{{ url_for('register_user') }}" class="btn btn-outline btn-block">üìù Crear cuenta de usuario</a>
          </div>
        {% endif %}
      </div>

      <!-- Credenciales de prueba (solo en desarrollo) -->
      {% if config.DEBUG %}
        <div class="alert alert-info" style="margin-top:12px; font-size:.95rem;">
          <strong>Credenciales de prueba:</strong><br>
          Admin ‚Üí Usuario: <code>admin</code> &nbsp; | &nbsp; Contrase√±a: <code>admin123</code>
        </div>
      {% endif %}
    </div>
  </div>

  <script>
    // Spinner y bloqueo al enviar
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      const submitBtn = this.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="spinner"></div> Verificando...';
    });

    // Toggle mostrar/ocultar contrase√±a
    (function(){
      const btn = document.getElementById('togglePwd');
      const input = document.getElementById('password');
      if(!btn || !input) return;
      btn.addEventListener('click', function(){
        const isPwd = input.getAttribute('type') === 'password';
        input.setAttribute('type', isPwd ? 'text' : 'password');
        btn.textContent = isPwd ? 'üôà' : 'üëÅ';
      });
    })();

    // Recargar CAPTCHA
    document.getElementById('captchaText').addEventListener('click', function() {
      // En tu implementaci√≥n real puedes hacer fetch a /captcha para regenerar;
      // por ahora recargamos la p√°gina (tu flujo actual).
      location.reload();
    });

  </script>
  <script>
    // === Cambio de tema (oscuro / claro) ===
    const themeToggle = document.getElementById('themeToggle');
    const root = document.documentElement;
    const key = 'theme';

    // Detectar preferencia del sistema o la guardada
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedTheme = localStorage.getItem(key);

    if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        root.classList.add('dark');
    }

    // Alternar tema
    themeToggle?.addEventListener('click', () => {
        const isDark = root.classList.toggle('dark');
        localStorage.setItem(key, isDark ? 'dark' : 'light');
    });
    </script>

</body>
</html>
