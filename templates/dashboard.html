<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Sistema de Turnos</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Bloque m칤nimo para tabs (usa tus variables existentes) -->
  <style>
    .tabs-header[role="tablist"] {
      display: flex;
      gap: .75rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .tabs-btn[role="tab"] {
      appearance: none;
      border: none;
      cursor: pointer;
      padding: 12px 18px;
      border-radius: var(--border-radius);
      font-size: 16px;
      font-weight: 600;
      background: #fff;
      color: var(--secondary-color);
      box-shadow: var(--shadow);
      transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
    }
    .tabs-btn[role="tab"]:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, .12);
    }
    .tabs-btn[aria-selected="true"] {
      background: var(--secondary-color);
      color: #fff;
    }
    .dashboard-section[aria-hidden="true"] {
      display: none;
    }

    /* Estilos ligeros para el mini-men칰 de cat치logos */
    .catalog-menu {
      display: flex; gap: .6rem; flex-wrap: wrap; margin-bottom: 1rem;
    }
    .catalog-menu .tabs-btn { padding: 10px 14px; font-size: 15px; }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <header class="header" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1>游늵 Dashboard Administrativo</h1>
        <p>Bienvenido, {{ admin_username }}</p>
      </div>
      <div>
        <a href="{{ url_for('logout') }}" class="btn btn-warning">游뛁 Cerrar Sesi칩n</a>
      </div>
    </header>

    <!-- Men칰 Tabs -->
    <nav class="nav-menu" style="background: white; padding: 1rem; border-radius: var(--border-radius); margin-bottom: 2rem;">
      <div class="tabs-header" role="tablist" aria-label="Secciones del dashboard" id="tabs-dashboard" data-save="local" data-default="estadisticas">
        <button class="tabs-btn" role="tab" id="tab-estadisticas" aria-controls="estadisticas" aria-selected="true">游늳 Estad칤sticas</button>
        <button class="tabs-btn" role="tab" id="tab-turnos" aria-controls="turnos" aria-selected="false">游늶 Gesti칩n de Turnos</button>
        <button class="tabs-btn" role="tab" id="tab-gestion-codigos" aria-controls="gestion-codigos" aria-selected="false">游댐 C칩digos</button>
        <button class="tabs-btn" role="tab" id="tab-catalogos" aria-controls="catalogos" aria-selected="false">游닄 Cat치logos</button>
        <button class="tabs-btn" role="tab" id="tab-busqueda" aria-controls="busqueda" aria-selected="false">游댌 B칰squeda</button>
      </div>
    </nav>

    <!-- Secci칩n: Estad칤sticas -->
    <section id="estadisticas" class="dashboard-section" role="tabpanel" aria-labelledby="tab-estadisticas" aria-hidden="false" tabindex="0">
      <h2>游늳 Estad칤sticas de Turnos</h2>
      <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <div class="stat-card" style="background: white; padding: 1.5rem; border-radius: var(--border-radius); text-align: center;">
          <h3>Total Turnos</h3>
          <div class="stat-number" id="total-turnos" style="font-size: 2rem; font-weight: bold; color: var(--secondary-color);">{{ stats.total_turnos }}</div>
        </div>
        <div class="stat-card" style="background: white; padding: 1.5rem; border-radius: var(--border-radius); text-align: center;">
          <h3>Pendientes</h3>
          <div class="stat-number" id="pendientes" style="font-size: 2rem; font-weight: bold; color: var(--warning-color);">{{ stats.pendientes }}</div>
        </div>
        <div class="stat-card" style="background: white; padding: 1.5rem; border-radius: var(--border-radius); text-align: center;">
          <h3>Resueltos</h3>
          <div class="stat-number" id="resueltos" style="font-size: 2rem; font-weight: bold; color: var(--success-color);">{{ stats.resueltos }}</div>
        </div>
        <div class="stat-card" style="background: white; padding: 1.5rem; border-radius: var(--border-radius); text-align: center;">
          <h3>Por Municipio</h3>
          <div class="stat-number" id="total-municipios" style="font-size: 2rem; font-weight: bold; color: var(--primary-color);">{{ stats.total_municipios }}</div>
        </div>
      </div>

      <!-- Gr치ficas -->
      <div class="charts-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
        <div style="background: white; padding: 1.5rem; border-radius: var(--border-radius);">
          <h4>Estatus de Turnos</h4>
          <canvas id="estatusChart"></canvas>
        </div>
        <div style="background: white; padding: 1.5rem; border-radius: var(--border-radius);">
          <h4>Turnos por Municipio</h4>
          <canvas id="municipiosChart"></canvas>
        </div>
      </div>
    </section>

    <!-- Secci칩n: Gesti칩n de Turnos -->
    <section id="turnos" class="dashboard-section" role="tabpanel" aria-labelledby="tab-turnos" aria-hidden="true" tabindex="0">
      <h2>游늶 Gesti칩n de Turnos</h2>
      <div class="filters" style="background: white; padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
          <select id="filterEstado" class="form-control">
            <option value="">Todos los estados</option>
            <option value="pendiente">Pendiente</option>
            <option value="atendido">Atendido</option>
            <option value="resuelto">Resuelto</option>
            <option value="cancelado">Cancelado</option>
          </select>
          <select id="filterMunicipio" class="form-control">
            <option value="">Todos los municipios</option>
            {% for municipio in municipios %}
            <option value="{{ municipio }}">{{ municipio }}</option>
            {% endfor %}
          </select>
          <button id="btnFiltrar" class="btn btn-primary">Filtrar</button>
        </div>
      </div>
      <div id="turnosList" class="turnos-list"></div>
    </section>

    <!-- Secci칩n: Gesti칩n de C칩digos -->
    <section id="gestion-codigos" class="dashboard-section" role="tabpanel" aria-labelledby="tab-gestion-codigos" aria-hidden="true" tabindex="0">
      <h2>游댐 Gesti칩n de C칩digos de Registro</h2>
      <div style="background: white; padding: 1.5rem; border-radius: var(--border-radius);">
        <div class="form-row">
          <div class="form-group">
            <button id="btnGenerarCodigo" class="btn btn-success">游꿞 Generar C칩digo de Registro</button>
          </div>
          <div class="form-group">
            <button id="btnVerCodigos" class="btn btn-primary">游늶 Ver C칩digos Activos</button>
          </div>
        </div>
        <div id="codigosResult" style="margin-top: 1rem;"></div>
      </div>
    </section>

    <!-- Secci칩n: B칰squeda -->
    <section id="busqueda" class="dashboard-section" role="tabpanel" aria-labelledby="tab-busqueda" aria-hidden="true" tabindex="0">
      <h2>游댌 B칰squeda Avanzada</h2>
      <div class="search-forms" style="background: white; padding: 1.5rem; border-radius: var(--border-radius);">
        <div class="form-row">
          <div class="form-group">
            <label for="searchCURP">Buscar por CURP</label>
            <input type="text" id="searchCURP" class="form-control" placeholder="Ingresa la CURP">
          </div>
          <div class="form-group">
            <label for="searchNombre">Buscar por Nombre</label>
            <input type="text" id="searchNombre" class="form-control" placeholder="Ingresa el nombre">
          </div>
        </div>
        <button id="btnBuscar" class="btn btn-primary">Buscar</button>
        <div id="searchResults" style="margin-top: 1rem;"></div>
      </div>
    </section>

    <!-- ===================== SECCI칍N: CAT츼LOGOS (MODIFICADA) ===================== -->
    <section id="catalogos" class="dashboard-section" role="tabpanel" aria-labelledby="tab-catalogos" aria-hidden="true" tabindex="0">
      <h2>游닄 Cat치logos</h2>

      <!-- Men칰 de selecci칩n de cat치logo -->
      <div class="catalog-menu" role="tablist" aria-label="Seleccionar cat치logo">
        <button class="tabs-btn" role="tab" id="cat-niveles" aria-controls="panel-catalogo" data-target="niveles" aria-selected="true">Niveles</button>
        <button class="tabs-btn" role="tab" id="cat-municipios" aria-controls="panel-catalogo" data-target="municipios" aria-selected="false">Municipios</button>
        <button class="tabs-btn" role="tab" id="cat-asuntos" aria-controls="panel-catalogo" data-target="asuntos" aria-selected="false">Asuntos</button>
      </div>

      <!-- Panel 칰nico (se rellena seg칰n el cat치logo activo) -->
      <div id="panel-catalogo" style="background:white;padding:1rem;border-radius:var(--border-radius);">
        <!-- Formularios (3) ocultos/visibles seg칰n selecci칩n -->
        <form id="formNivel" class="form-row cat-form" data-kind="niveles" style="margin-bottom:.75rem;">
          <input type="text" class="form-control" placeholder="Clave (ej: preescolar)" id="nivelClave" required>
          <input type="text" class="form-control" placeholder="Nombre (ej: Preescolar)" id="nivelNombre" required>
          <label style="display:flex;align-items:center;gap:.4rem;">
            <input type="checkbox" id="nivelActivo" checked> Activo
          </label>
          <button type="submit" class="btn btn-success">Agregar</button>
        </form>

        <form id="formMunicipio" class="form-row cat-form" data-kind="municipios" style="margin-bottom:.75rem; display:none;">
          <input type="text" class="form-control" placeholder="Clave (ej: aguascalientes)" id="munClave" required>
          <input type="text" class="form-control" placeholder="Nombre (ej: Aguascalientes)" id="munNombre" required>
          <label style="display:flex;align-items:center;gap:.4rem;">
            <input type="checkbox" id="munActivo" checked> Activo
          </label>
          <button type="submit" class="btn btn-success">Agregar</button>
        </form>

        <form id="formAsunto" class="form-row cat-form" data-kind="asuntos" style="margin-bottom:.75rem; display:none;">
          <input type="text" class="form-control" placeholder="Clave (ej: certificacion)" id="asuntoClave" required>
          <input type="text" class="form-control" placeholder="Nombre (ej: Certificaci칩n)" id="asuntoNombre" required>
          <label style="display:flex;align-items:center;gap:.4rem;">
            <input type="checkbox" id="asuntoActivo" checked> Activo
          </label>
          <button type="submit" class="btn btn-success">Agregar</button>
        </form>

        <!-- Contenedores de tabla (solo se muestra uno a la vez) -->
        <div id="tablaNiveles" class="cat-table" data-kind="niveles"></div>
        <div id="tablaMunicipios" class="cat-table" data-kind="municipios" style="display:none;"></div>
        <div id="tablaAsuntos" class="cat-table" data-kind="asuntos" style="display:none;"></div>
      </div>
    </section>
    <!-- =================== FIN SECCI칍N: CAT츼LOGOS (MODIFICADA) =================== -->

  </div>

  <!-- Tu JS principal -->
  <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

  <!-- Sistema de pesta침as -->
  <script>
  (function(){
    const root = document.getElementById('tabs-dashboard');
    if(!root) return;

    const saveMode = (root.dataset.save || 'local').toLowerCase();
    const def      = (root.dataset.default || 'estadisticas').toLowerCase();

    const tabs  = Array.from(root.querySelectorAll('[role="tab"]'));
    const panes = tabs.map(t => document.getElementById(t.getAttribute('aria-controls'))).filter(Boolean);
    const order = tabs.map(t => t.id);

    tabs.forEach((t, i) => {
      t.addEventListener('click', () => select(t.id));
      t.addEventListener('keydown', (ev) => {
        switch(ev.key){
          case 'ArrowRight': ev.preventDefault(); selectByIndex(i+1); break;
          case 'ArrowLeft':  ev.preventDefault(); selectByIndex(i-1); break;
          case 'Home':       ev.preventDefault(); selectByIndex(0); break;
          case 'End':        ev.preventDefault(); selectByIndex(order.length-1); break;
          case 'Enter':
          case ' ':          ev.preventDefault(); select(t.id); break;
        }
      });
    });

    function selectByIndex(idx){
      if (idx < 0) idx = order.length - 1;
      if (idx >= order.length) idx = 0;
      select(order[idx]);
    }

    function select(tabId, opts = { focus:true, pushHash:true, persist:true }){
      const tab = document.getElementById(tabId);
      if(!tab) return;
      const panelId = tab.getAttribute('aria-controls');
      const panel = document.getElementById(panelId);
      if(!panel) return;

      tabs.forEach(t => t.setAttribute('aria-selected','false'));
      panes.forEach(p => p.setAttribute('aria-hidden','true'));

      tab.setAttribute('aria-selected','true');
      panel.setAttribute('aria-hidden','false');
      if (opts.focus) panel.focus({ preventScroll:false });

      const hash = tab.id.replace(/^tab-/, '');
      if (saveMode === 'local' && opts.persist) {
        try { localStorage.setItem('dashboard.activeTab', tabId); } catch(e){}
      }
      if (opts.pushHash && hash) {
        history.replaceState(null, '', '#' + hash);
      }
    }

    (function init(){
      const byHash = (location.hash || '').replace('#','').toLowerCase();
      if (byHash) {
        const btn = document.getElementById('tab-' + byHash);
        if (btn) return select(btn.id, {focus:false, pushHash:true, persist:false});
      }
      if (saveMode === 'local') {
        try {
          const saved = localStorage.getItem('dashboard.activeTab');
          if (saved && document.getElementById(saved)) {
            return select(saved, {focus:false, pushHash:true, persist:false});
          }
        } catch(e){}
      }
      select('tab-' + def, {focus:false, pushHash:true, persist:false});
    })();

    window.addEventListener('hashchange', () => {
      const byHash = (location.hash || '').replace('#','').toLowerCase();
      const btn = document.getElementById('tab-' + byHash);
      if (btn) select(btn.id, {focus:false, pushHash:false});
    });
  })();
  </script>

  <!-- Conmutador de cat치logos (nuevo) -->
  <script>
  (function(){
    const menuButtons = Array.from(document.querySelectorAll('#catalogos .catalog-menu [role="tab"]'));
    const forms = Array.from(document.querySelectorAll('#catalogos .cat-form'));
    const tables = Array.from(document.querySelectorAll('#catalogos .cat-table'));

    async function loadCatalog(kind){
      // Usa tus funciones existentes de dashboard.js:
      // cargarNiveles / cargarMunicipios / cargarAsuntos
      try {
        if (kind === 'niveles' && typeof cargarNiveles === 'function') await cargarNiveles();
        if (kind === 'municipios' && typeof cargarMunicipios === 'function') await cargarMunicipios();
        if (kind === 'asuntos' && typeof cargarAsuntos === 'function') await cargarAsuntos();
      } catch(e) { console.error('Error cargando cat치logo', kind, e); }
    }

    function activate(kind){
      // Estado de botones
      menuButtons.forEach(btn => btn.setAttribute('aria-selected', String(btn.dataset.target === kind)));
      // Mostrar/ocultar forms
      forms.forEach(f => f.style.display = (f.dataset.kind === kind ? '' : 'none'));
      // Mostrar/ocultar tablas
      tables.forEach(t => t.style.display = (t.dataset.kind === kind ? '' : 'none'));
      // Cargar datos
      loadCatalog(kind);
    }

    menuButtons.forEach(btn => {
      btn.addEventListener('click', () => activate(btn.dataset.target));
      btn.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); activate(btn.dataset.target); }
      });
    });

    // Inicial: Niveles
    activate('niveles');
  })();
  </script>
</body>
</html>
