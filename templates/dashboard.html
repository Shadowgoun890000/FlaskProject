<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - Sistema de Turnos</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header" aria-label="Barra superior">
      <div>
        <h1 style="margin:0;">ğŸ“Š Dashboard Administrativo</h1>
        <p class="help-text" style="margin:0;">Bienvenido, {{ admin_username }}</p>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="themeToggle" class="btn theme-toggle" type="button" title="Cambiar tema">ğŸŒ“</button>
        <a href="{{ url_for('index') }}" class="btn btn-secondary" aria-label="Ir a vista pÃºblica">ğŸŒ Vista PÃºblica</a>
        <a href="{{ url_for('logout') }}" class="btn btn-warning" aria-label="Cerrar sesiÃ³n">ğŸšª Cerrar SesiÃ³n</a>
      </div>
    </header>

    <script>
        // === Cambio de tema (oscuro / claro) ===
        const themeToggle = document.getElementById('themeToggle');
        const root = document.documentElement;
        const key = 'theme';

        // Detectar preferencia del sistema o la guardada
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const savedTheme = localStorage.getItem(key);

        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            root.classList.add('dark');
        }

        // Alternar tema
        themeToggle?.addEventListener('click', () => {
            const isDark = root.classList.toggle('dark');
            localStorage.setItem(key, isDark ? 'dark' : 'light');
    });
    </script>


    <!-- MenÃº de NavegaciÃ³n -->
    <nav class="nav-menu" aria-label="NavegaciÃ³n principal" style="margin-bottom: 20px;">
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <a href="#estadisticas" class="btn btn-primary">ğŸ“ˆ EstadÃ­sticas</a>
        <a href="#turnos" class="btn btn-primary">ğŸ“‹ GestiÃ³n de Turnos</a>
        <a href="#busqueda" class="btn btn-primary">ğŸ” BÃºsqueda</a>
        <a href="#gestion-codigos" class="btn btn-primary">ğŸ”‘ CÃ³digos</a>
      </div>
    </nav>

    <!-- EstadÃ­sticas -->
    <section id="estadisticas" class="section" aria-labelledby="title-estadisticas">
      <h2 id="title-estadisticas">ğŸ“ˆ EstadÃ­sticas de Turnos</h2>

      <div class="stats-grid" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:12px; margin-top:12px;">
        <div class="stat-card">
          <h3 style="margin:0 0 6px 0;">Total Turnos</h3>
          <div class="stat-number">{{ stats.total_turnos }}</div>
        </div>
        <div class="stat-card">
          <h3 style="margin:0 0 6px 0;">Pendientes</h3>
          <div class="stat-number">{{ stats.pendientes }}</div>
        </div>
        <div class="stat-card">
          <h3 style="margin:0 0 6px 0;">Resueltos</h3>
          <div class="stat-number">{{ stats.resueltos }}</div>
        </div>
        <div class="stat-card">
          <h3 style="margin:0 0 6px 0;">Por Municipio</h3>
          <div class="stat-number">{{ stats.total_municipios }}</div>
        </div>
      </div>

      <div class="charts-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:16px;">
        <div class="card" style="padding:16px;">
          <h4 style="margin:0 0 10px 0;">Estatus de Turnos</h4>
          <canvas id="estatusChart" role="img" aria-label="GrÃ¡fica de estatus de turnos"></canvas>
        </div>
        <div class="card" style="padding:16px;">
          <h4 style="margin:0 0 10px 0;">Turnos por Municipio</h4>
          <canvas id="municipiosChart" role="img" aria-label="GrÃ¡fica de turnos por municipio"></canvas>
        </div>
      </div>
    </section>

    <!-- GestiÃ³n de Turnos -->
    <section id="turnos" class="section" aria-labelledby="title-gestion" style="margin-top:20px;">
      <h2 id="title-gestion">ğŸ“‹ GestiÃ³n de Turnos</h2>

      <div class="panel" style="padding:12px; margin:12px 0;">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <label for="filterEstado" class="help-text" style="min-width:140px;">Estado:</label>
          <select id="filterEstado" class="form-control" aria-label="Filtrar por estado">
            <option value="">Todos los estados</option>
            <option value="pendiente">Pendiente</option>
            <option value="atendido">Atendido</option>
            <option value="resuelto">Resuelto</option>
            <option value="cancelado">Cancelado</option>
          </select>

          <label for="filterMunicipio" class="help-text" style="min-width:140px;">Municipio:</label>
          <select id="filterMunicipio" class="form-control" aria-label="Filtrar por municipio">
            <option value="">Todos los municipios</option>
            {% for municipio in municipios %}
            <option value="{{ municipio }}">{{ municipio }}</option>
            {% endfor %}
          </select>

          <button id="btnFiltrar" class="btn btn-primary" type="button">Filtrar</button>
        </div>
      </div>

      <div id="turnosList" class="turnos-list" aria-live="polite" aria-busy="false">
        <!-- Render de turnos por dashboard.js -->
      </div>
    </section>

    <!-- GestiÃ³n de CÃ³digos de Registro -->
    <section id="gestion-codigos" class="section" aria-labelledby="title-codigos" style="margin-top:20px;">
      <h2 id="title-codigos">ğŸ”‘ GestiÃ³n de CÃ³digos de Registro</h2>

      <div class="panel" style="padding:16px; margin-top:10px;">
        <div class="form-row">
          <div class="form-group">
            <button id="btnGenerarCodigo" class="btn btn-success" type="button">ğŸ« Generar CÃ³digo</button>
          </div>
          <div class="form-group">
            <button id="btnVerCodigos" class="btn btn-secondary" type="button">ğŸ“‹ Ver CÃ³digos Activos</button>
          </div>
        </div>

        <div id="codigosResult" style="margin-top: 10px;" aria-live="polite"></div>
      </div>
    </section>

    <!-- BÃºsqueda -->
    <section id="busqueda" class="section" aria-labelledby="title-busqueda" style="margin-top:20px;">
      <h2 id="title-busqueda">ğŸ” BÃºsqueda Avanzada</h2>

      <div class="panel" style="padding:16px; margin-top:10px;">
        <div class="form-row">
          <div class="form-group">
            <label for="searchCURP">Buscar por CURP</label>
            <input type="text" id="searchCURP" class="form-control" placeholder="Ingresa la CURP" autocomplete="off">
          </div>
          <div class="form-group">
            <label for="searchNombre">Buscar por Nombre</label>
            <input type="text" id="searchNombre" class="form-control" placeholder="Ingresa el nombre" autocomplete="off">
          </div>
        </div>
        <button id="btnBuscar" class="btn btn-primary" type="button">Buscar</button>

        <div id="searchResults" style="margin-top: 12px;" aria-live="polite">
          <!-- Resultados de bÃºsqueda -->
        </div>
      </div>
    </section>
  </div>

  <!-- Tu lÃ³gica principal del dashboard -->
  <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

  <!-- GestiÃ³n de cÃ³digos (mantenido aquÃ­ para no tocar dashboard.js) -->
  <script>
    // Botones de gestiÃ³n
    const btnGenerar = document.getElementById('btnGenerarCodigo');
    const btnVer = document.getElementById('btnVerCodigos');
    const resultBox = document.getElementById('codigosResult');

    if (btnGenerar) btnGenerar.addEventListener('click', generarCodigoRegistro);
    if (btnVer) btnVer.addEventListener('click', verCodigosActivos);

    async function generarCodigoRegistro() {
      try {
        resultBox.innerHTML = '<div class="alert alert-info">Generando cÃ³digo...</div>';
        const response = await fetch('/admin/generate-code');
        const result = await response.json();

        if (result.success) {
          resultBox.innerHTML = `
            <div class="alert alert-success">
              <strong>âœ… ${result.message}</strong>
              <div class="card" style="padding:10px; margin-top:8px;">
                <code style="font-size:1.15rem; display:block;">${result.code}</code>
              </div>
              <p class="help-text" style="margin-top:6px;">Comparte este cÃ³digo con quien necesite registrarse. VÃ¡lido por 24 horas.</p>
            </div>`;
        } else {
          resultBox.innerHTML = `<div class="alert alert-error">âŒ Error: ${result.error || 'No se pudo generar el cÃ³digo'}</div>`;
        }
      } catch (e) {
        resultBox.innerHTML = `<div class="alert alert-error">âŒ Error de conexiÃ³n</div>`;
      }
    }

    async function verCodigosActivos() {
      try {
        resultBox.innerHTML = '<div class="alert alert-info">Consultando cÃ³digos...</div>';
        const response = await fetch('/admin/active-codes');
        const result = await response.json();

        if (result.success) {
          if (result.active_codes === 0) {
            resultBox.innerHTML = `<div class="alert alert-info">No hay cÃ³digos activos</div>`;
          } else {
            let html = `<div class="card" style="padding:12px;"><strong>ğŸ“‹ CÃ³digos Activos: ${result.active_codes}</strong>`;
            for (const [code, data] of Object.entries(result.codes)) {
              const expires = new Date(data.expires_at).toLocaleString();
              html += `
                <div class="panel" style="padding:10px; margin-top:10px;">
                  <div><strong>CÃ³digo:</strong> <code>${code}</code></div>
                  <div><strong>Expira:</strong> ${expires}</div>
                  <div><strong>Usos restantes:</strong> ${data.max_uses}</div>
                </div>`;
            }
            html += `</div>`;
            resultBox.innerHTML = html;
          }
        } else {
          resultBox.innerHTML = `<div class="alert alert-error">âŒ Error: ${result.error || 'No se pudieron obtener los cÃ³digos'}</div>`;
        }
      } catch (e) {
        resultBox.innerHTML = `<div class="alert alert-error">âŒ Error de conexiÃ³n</div>`;
      }
    }
  </script>
</body>
</html>
